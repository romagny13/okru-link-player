class OKRuLinkPlayer{constructor(options={}){this.version="0.1.2";this._options={rootContainer:null,showPreviewOnHover:false,tooltipDelay:300,tooltipDefaultWidth:480,tooltipDefaultHeight:270,tooltipZoomEffect:true,tooltipMobileWidth:"90vw",tooltipMobileHeight:"auto",tooltipMobilePosition:"center",tooltipMobileTimeout:3e3,tooltipFallbackImage:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgwIiBoZWlnaHQ9IjI3MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMWExYTFhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBub24gZGlzcG9uaWJsZTwvdGV4dD48L3N2Zz4=",showOnInit:false,showInPopup:false,popupWidth:"90vw",popupHeight:"auto",popupMaxWidth:"1200px",embedBaseUrl:options.embedBaseUrl||"https://ok.ru/videoembed/",...options};this._activePlayers=new Map;this._tooltipCache=new Map;this._videoInfoCache=new Map;this._activePopup=null;this._isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0;this._tooltipTimeout=null;this._tooltipDelayTimeout=null;this._rootElement=this._options.rootContainer instanceof HTMLElement?this._options.rootContainer:document.querySelector(this._options.rootContainer)||document;this._init()}_init(){this._addGlobalStyles();this._bindEvents();if(this._options.showOnInit){this._initializeDefaultPlayers()}}_addGlobalStyles(){if(!document.querySelector("#okru-preview-styles")){const style=document.createElement("style");style.id="okru-preview-styles";style.textContent=`\n              .okru-player-wrapper {\n                    position: relative;\n                    width: 100%;\n                    margin: 20px 0;\n                    opacity: 0;\n                    transform: translateY(20px);\n                    transition: all 0.3s ease;\n                    display: none;\n                }\n    \n                .okru-player-wrapper.active {\n                    opacity: 1;\n                    transform: translateY(0);\n                    display: block;\n                }\n    \n                .okru-player-wrapper:before {\n                    content: '';\n                    display: block;\n                    padding-top: 56.25%;\n                }\n    \n                .okru-player-wrapper iframe {\n                    position: absolute;\n                    top: 0;\n                    left: 0;\n                    width: 100%;\n                    height: 100%;\n                    border: none;\n                    border-radius: 8px;\n                    overflow: hidden; /* Empêche le défilement interne */\n                    scrollbar-width: none; /* Masque la scrollbar (Firefox) */\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n                }\n    \n                .okru-tooltip {\n                    position: fixed;\n                    background: #fff;\n                    border-radius: 8px;\n                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n                    padding: 0;\n                    z-index: 100;\n                    opacity: 0;\n                    transform: translateY(10px);\n                    transition: all 0.3s ease;\n                    overflow: hidden;\n                    pointer-events: none;\n                    width: ${this._isTouchDevice?this._options.tooltipMobileWidth:this._options.tooltipDefaultWidth+"px"};\n                    ${this._isTouchDevice?`height: ${this._options.tooltipMobileHeight};`:""}\n                }\n    \n                .okru-tooltip.active {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n    \n                .okru-tooltip-thumbnail {\n                    position: relative;\n                    width: 100%;\n                    background: #000;\n                }\n    \n                .okru-tooltip-thumbnail img {\n                    width: 100%;\n                    display: block;\n                    transition: transform 0.3s ease;\n                }\n    \n                ${this._options.tooltipZoomEffect?`\n                .okru-tooltip:hover .okru-tooltip-thumbnail img {\n                    transform: scale(1.05);\n                }\n                `:""}\n    \n              .okru-tooltip-play {\n                  position: absolute;\n                  top: 50%;\n                  left: 50%;\n                  transform: translate(-50%, -50%);\n                  width: 60px;\n                  height: 60px;\n                  background: rgba(0,0,0,0.7);\n                  border-radius: 50%;\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n              }\n    \n              .okru-tooltip-play::after {\n                  content: '';\n                  width: 0;\n                  height: 0;\n                  border-style: solid;\n                  border-width: 10px 0 10px 20px;\n                  border-color: transparent transparent transparent #ffffff;\n                  margin-left: 5px;\n              }\n    \n              .okru-tooltip-info {\n                  padding: 12px;\n                  background: #fff;\n              }\n    \n              .okru-tooltip-title {\n                  font-family: Arial, sans-serif;\n                  font-size: 14px;\n                  color: #333;\n                  margin: 0;\n                  line-height: 1.4;\n                  font-weight: 600;\n                  overflow: hidden;\n                  text-overflow: ellipsis;\n                  display: -webkit-box;\n                  -webkit-line-clamp: 2;\n                  -webkit-box-orient: vertical;\n              }\n    \n              .okru-loader {\n                  position: absolute;\n                  top: 50%;\n                  left: 50%;\n                  transform: translate(-50%, -50%);\n                  width: 40px;\n                  height: 40px;\n                  border: 3px solid rgba(255,255,255,0.3);\n                  border-top: 3px solid #fff;\n                  border-radius: 50%;\n                  animation: spin 1s linear infinite;\n              }\n    \n              @keyframes spin {\n                  0% { transform: translate(-50%, -50%) rotate(0deg); }\n                  100% { transform: translate(-50%, -50%) rotate(360deg); }\n              }\n  \n              .okru-popup-overlay {\n                    position: fixed;\n                    top: 0;\n                    left: 0;\n                    width: 100%;\n                    height: 100%;\n                    background: rgba(0, 0, 0, 0.8);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: 1000;\n                    opacity: 0;\n                    transition: opacity 0.3s ease;\n                    padding: 20px;\n                    box-sizing: border-box;\n                }\n                \n                .okru-popup-overlay.active {\n                    opacity: 1;\n                }\n                \n                .okru-popup-container {\n                    position: relative;\n                    width: ${this._options.popupWidth};\n                    max-width: ${this._options.popupMaxWidth};\n                    background: #000;\n                    border-radius: 8px;\n                    overflow: hidden;\n                    transform: scale(0.9);\n                    transition: transform 0.3s ease;\n                }\n                \n                .okru-popup-container:before {\n                    content: '';\n                    display: block;\n                    padding-top: 56.25%;\n                }\n                \n                .okru-popup-overlay.active .okru-popup-container {\n                    transform: scale(1);\n                }\n                \n                .okru-popup-close {\n                    position: absolute;\n                    top: -40px;\n                    right: 0;\n                    width: 40px;\n                    height: 40px;\n                    background: #fff;\n                    border-radius: 50%;\n                    cursor: pointer;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    font-size: 24px;\n                    color: #000;\n                    border: none;\n                    padding: 0;\n                    z-index: 2;\n                }\n                \n                .okru-popup-close:hover {\n                    background: #f0f0f0;\n                }\n                \n                .okru-popup-iframe {\n                    position: absolute;\n                    top: 0;\n                    left: 0;\n                    width: 100%;\n                    height: 100%;\n                    border: none;\n                }\n  \n                @media (max-width: 768px) {\n                    .okru-popup-overlay {\n                        padding: 0;\n                    }\n  \n                    .okru-popup-container {\n                        width: 100%;\n                        height: auto;\n                        border-radius: 0;\n                    }\n  \n                    .okru-popup-close {\n                        top: 10px;\n                        right: 10px;\n                        background: rgba(255, 255, 255, 0.9);\n                    }\n                }\n            `;document.head.appendChild(style)}}_bindEvents(){if(this._isTouchDevice){this._rootElement.addEventListener("touchstart",this._handleTouch.bind(this),{passive:true})}else if(this._options.showPreviewOnHover){this._rootElement.addEventListener("mouseover",this._handleHover.bind(this));this._rootElement.addEventListener("mouseout",this._handleMouseOut.bind(this))}this._rootElement.addEventListener("click",this._handleClick.bind(this))}async _getVideoTitle(videoId,trigger){return trigger?trigger.textContent.trim():"Vidéo OK.ru"}_initializeDefaultPlayers(){const triggers=this._rootElement.querySelectorAll('[data-okru-link][data-show-on-init="true"]');triggers.forEach((trigger=>{this._loadVideo(trigger)}))}_handleTouch(event){const trigger=event.target.closest("[data-okru-link]");if(!trigger||!this._options.showPreviewOnHover)return;if(this._tooltipTimeout){clearTimeout(this._tooltipTimeout)}this._showTooltip(trigger);this._tooltipTimeout=setTimeout((()=>{this.hideTooltip()}),this._options.tooltipMobileTimeout)}_handleHover(event){const trigger=event.target.closest("[data-okru-link]");if(!trigger||!this._options.showPreviewOnHover)return;if(this._tooltipDelayTimeout){clearTimeout(this._tooltipDelayTimeout)}this._tooltipDelayTimeout=setTimeout((()=>{this._showTooltip(trigger)}),this._options.tooltipDelay)}async _loadTooltipContent(tooltip,videoId,trigger){const thumbnailContainer=document.createElement("div");thumbnailContainer.className="okru-tooltip-thumbnail";const loader=document.createElement("div");loader.className="okru-loader";thumbnailContainer.appendChild(loader);tooltip.appendChild(thumbnailContainer);let videoInfo=this._videoInfoCache.get(videoId);if(!videoInfo){const thumbnail=trigger.getAttribute("data-thumbnail")||this._options.tooltipFallbackImage;videoInfo={thumbnail:thumbnail,title:await this._getVideoTitle(videoId,trigger)};this._videoInfoCache.set(videoId,videoInfo)}const img=new Image;img.onload=()=>{this._completeTooltipLoad(tooltip,thumbnailContainer,loader,img,videoInfo)};img.onerror=()=>{img.src=this._options.tooltipFallbackImage};img.src=videoInfo.thumbnail}async _showTooltip(trigger){const videoId=this._getVideoId(trigger.href);if(!videoId)return;const target=this._getTargetId(trigger);if(this._activePlayers.has(target)&&this._activePlayers.get(target).wrapper.classList.contains("active")){return}const tooltip=this._createTooltip();if(this._isTouchDevice){this._positionMobileTooltip(tooltip,this._options.tooltipMobilePosition)}else{const rect=trigger.getBoundingClientRect();tooltip.style.left=`${rect.left}px`;tooltip.style.top=`${rect.bottom+10}px`}await this._loadTooltipContent(tooltip,videoId,trigger)}_completeTooltipLoad(tooltip,thumbnailContainer,loader,img,videoInfo){loader.remove();thumbnailContainer.appendChild(img);const playButton=document.createElement("div");playButton.className="okru-tooltip-play";thumbnailContainer.appendChild(playButton);const infoDiv=document.createElement("div");infoDiv.className="okru-tooltip-info";const titleP=document.createElement("p");titleP.className="okru-tooltip-title";titleP.textContent=videoInfo.title;infoDiv.appendChild(titleP);tooltip.appendChild(infoDiv);tooltip.classList.add("active")}_positionMobileTooltip(tooltip,position){const viewportHeight=window.innerHeight;const tooltipHeight=this._options.tooltipMobileHeight==="auto"?tooltip.offsetHeight:parseInt(this._options.tooltipMobileHeight);switch(position){case"top":tooltip.style.top="20px";break;case"bottom":tooltip.style.bottom="20px";break;case"center":default:tooltip.style.top=`${(viewportHeight-tooltipHeight)/2}px`;break}tooltip.style.left=`${(window.innerWidth-parseInt(this._options.tooltipMobileWidth))/2}px`}_handleMouseOut(event){const tooltip=document.querySelector(".okru-tooltip");if(tooltip){tooltip.remove()}}_createTooltip(){const tooltip=document.createElement("div");tooltip.className="okru-tooltip";document.body.appendChild(tooltip);return tooltip}_getTargetId(trigger){return trigger.getAttribute("data-okru-target")||"inline-"+trigger.href}_handleClick(event){const trigger=event.target.closest("[data-okru-link]");if(!trigger)return;event.preventDefault();const showInPopup=trigger.getAttribute("data-show-in-popup")==="true"?true:trigger.getAttribute("data-show-in-popup")==="false"?false:this._options.showInPopup;if(showInPopup){this._loadVideoInPopup(trigger)}else{const target=this._getTargetId(trigger);const activePlayer=this._activePlayers.get(target);if(activePlayer&&activePlayer.trigger===trigger){this._hideVideo(activePlayer.wrapper,trigger);return}if(activePlayer){this._hideVideo(activePlayer.wrapper,activePlayer.trigger)}this._loadVideo(trigger)}}_loadVideoInPopup(trigger){const videoId=this._getVideoId(trigger.href);if(!videoId)return;if(this._activePopup){this._closePopup()}const overlay=document.createElement("div");overlay.className="okru-popup-overlay";const container=document.createElement("div");container.className="okru-popup-container";const closeButton=document.createElement("button");closeButton.className="okru-popup-close";closeButton.innerHTML="×";closeButton.addEventListener("click",(e=>{e.stopPropagation();this._closePopup()}));const embedUrl=`${this._options.embedBaseUrl}${videoId}`;const iframe=document.createElement("iframe");iframe.className="okru-popup-iframe";iframe.src=`${embedUrl}?autoplay=1`;iframe.allow="autoplay; fullscreen";iframe.allowFullscreen=true;iframe.scrolling="no";container.appendChild(closeButton);container.appendChild(iframe);overlay.appendChild(container);document.body.appendChild(overlay);document.body.style.overflow="hidden";this._activePopup=overlay;const handleEscape=e=>{if(e.key==="Escape"){this._closePopup();document.removeEventListener("keydown",handleEscape)}};document.addEventListener("keydown",handleEscape);overlay.addEventListener("click",(e=>{if(e.target===overlay){this._closePopup()}}));if(this._isTouchDevice){let touchStartY=0;let touchEndY=0;overlay.addEventListener("touchstart",(e=>{touchStartY=e.touches[0].clientY}),{passive:true});overlay.addEventListener("touchend",(e=>{touchEndY=e.changedTouches[0].clientY;if(Math.abs(touchEndY-touchStartY)>50){this._closePopup()}}),{passive:true})}requestAnimationFrame((()=>{overlay.classList.add("active")}))}_closePopup(){if(this._activePopup){this._activePopup.classList.remove("active");document.body.style.overflow="";setTimeout((()=>{this._activePopup.remove();this._activePopup=null}),300)}}_hideVideo(wrapper,trigger){const target=this._getTargetId(trigger);trigger.classList.remove("active");const iframe=wrapper.querySelector("iframe");if(iframe){const currentSrc=new URL(iframe.src);currentSrc.searchParams.set("autoplay","0");iframe.src=currentSrc.toString()}wrapper.classList.remove("active");this._activePlayers.delete(target);setTimeout((()=>{wrapper.remove()}),300)}_loadVideo(trigger){const videoId=this._getVideoId(trigger.href);if(!videoId)return;const targetSelector=trigger.getAttribute("data-okru-target");const autoplay=trigger.getAttribute("data-autoplay")==="true";const wrapper=document.createElement("div");wrapper.className="okru-player-wrapper";const embedUrl=`${this._options.embedBaseUrl}${videoId}`;const iframe=document.createElement("iframe");iframe.src=`${embedUrl}?autoplay=${autoplay?1:0}&nochat=1`;iframe.allow="autoplay; fullscreen";iframe.allowFullscreen=true;iframe.scrolling="no";wrapper.appendChild(iframe);if(targetSelector){const targetElement=document.querySelector(targetSelector);if(!targetElement)return;targetElement.innerHTML="";targetElement.appendChild(wrapper)}else{trigger.parentNode.insertBefore(wrapper,trigger.nextSibling)}this._activePlayers.set(this._getTargetId(trigger),{wrapper:wrapper,trigger:trigger});trigger.classList.add("active");setTimeout((()=>wrapper.classList.add("active")),50)}_getVideoId(url){const videoMatch=url.match(/ok\.ru\/video(?:embed)?\/([a-zA-Z0-9]+)/);return videoMatch?videoMatch[1]:null}}